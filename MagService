package com.example.mydemopos.service;

import static android.content.ContentValues.TAG;

import android.app.IntentService;
import android.app.Notification;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Intent;
import android.graphics.BitmapFactory;
import android.os.Binder;
import android.os.Build;
import android.os.IBinder;
import android.util.Log;
import android.widget.Toast;

import androidx.annotation.MainThread;
import androidx.annotation.Nullable;
import androidx.annotation.RequiresApi;
import androidx.annotation.UiThread;
import androidx.annotation.WorkerThread;
import androidx.core.app.NotificationCompat;

import com.example.mydemopos.R;
import com.example.mydemopos.activity.MainActivity;
import com.pax.api.MagException;
import com.pax.api.MagManager;

import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.FutureTask;

public class MagCardService extends Service {
    MagManager magManager = null;
    String info = "";
    MagCardCheckBinder magCardCheckBinder = new MagCardCheckBinder();
    public class MagCardCheckBinder extends Binder{
        //获取磁条卡信息
        public String checkCardInfo() throws MagException, ExecutionException, InterruptedException {
            magManager = MagManager.getInstance();
            magManager.magOpen();
            Thread t1 = new Thread(() -> {
                long start = System.currentTimeMillis();
                String ver = "";
                boolean isSwip = false;
                while (true){
                    try {
                        ver = magManager.magGetVersion();
                        isSwip = magManager.magSwiped();
                        Log.e(TAG, "ver and isSwip are" + ver + " " + isSwip );
                        MagManager.TrackInfo trackInfo = magManager.magRead();
                        info = trackInfo.track2;
                        Log.e(TAG, info + " " +ver );
                        //检测到之后，立马跳出循环，不再执行
                        if(!("").equals(info)){
                            magManager.magClose();//及时关闭资源
                            break;
                        }
                    } catch (MagException e) {
                        Log.e(TAG, "请刷卡");
                    }
                    long end = System.currentTimeMillis();
                    Log.e("diff"," 运行秒数：" +(end - start) / 1000 );
                    //5秒钟之内 未刷卡 直接break
                    if((end - start) / 1000 == 5){
                        break;
                    }
                }
            });
            t1.start();//开启刷卡线程
            t1.join();//等待刷卡线程结束
            return info;
        }
    }

    @Override
    public IBinder onBind(Intent intent) {
        // TODO: Return the communication channel to the service.
        return magCardCheckBinder;
    }

    @Override
    public void onCreate() {
        Log.e(TAG, "onCreate: " );
        super.onCreate();
        startForeground(1,getNotification("磁条卡服务","磁条卡正在检测信息"));
    }

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        Log.e("startcommand", "onStartCommand: ");
        return super.onStartCommand(intent, flags, startId);
    }

    @MainThread
    public Notification getNotification(String title,String message){
        String id = "my_channel_01";
        String name="my_channel_name";
        NotificationManager notificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
        Notification notification = null;
        Notification.Builder builder = new Notification.Builder(this);//创建builder
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            NotificationChannel mChannel = new NotificationChannel(id, name, NotificationManager.IMPORTANCE_LOW);
            notificationManager.createNotificationChannel(mChannel);
            notification = builder
                    .setChannelId(id)
                    .setContentTitle(title)
                    .setContentText(message)
                    .setSmallIcon(R.mipmap.main_mag).build();
        } else {
            NotificationCompat.Builder notificationBuilder = new NotificationCompat.Builder(this)
                    .setContentTitle(title)
                    .setContentText(message)
                    .setSmallIcon(R.mipmap.main_mag)
                    .setOngoing(true);
            notification = notificationBuilder.build();
        }
        return notification;
    }

    @Override
    public boolean onUnbind(Intent intent) {
        Log.e("unbind-service","onUnbind");
        return super.onUnbind(intent);
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        Log.e("destory-service", "onDestroy: " );
    }

}
